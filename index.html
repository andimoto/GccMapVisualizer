<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
        <link type="text/css" rel="stylesheet" href="css/style.css"/>
        <link type="text/css" rel="stylesheet" href="css/bootstrap.css">
        <link type="text/css" rel="stylesheet" href="css/bootstrap-theme.css">
        <script src="js/jquery.js"></script>
        <script src="js/bootstrap.js"></script>
        <script src="js/d3.js" charset="utf-8"></script>
        <script src="js/map_parse.js" charset="utf-8"></script>
    </head>
    <body>
        <a href="https://github.com/jotux/GccMapVisualizer"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub"></a>
        <div id="body">
            <div class="container">
                <div class="page-header">
                    <h1>GCC LINKER MAP VISUALIZER <small>parse gcc linker maps to visually understand code usage</small></h1>
                    <input class="btn btn-default btn-file" type="file" id="file" name="file" enctype="multipart/form-data" />
                </div>
                <div id="chart_container"></div>
            </div>
        </div>
        <script type="text/javascript">
            // Base on this d3 example: http://mbostock.github.io/d3/talk/20111018/partition.html
            document.getElementById('file').addEventListener('change', readFile, false);
            function readFile (evt)
            {
                var files = evt.target.files;
                var file = files[0];
                var reader = new FileReader();
                reader.onload = function()
                {
                    var mapData = ParseMapFile(this.result);
                    loadChart(mapData[0],mapData[1]);
                }
                reader.readAsText(file)
            }
            function loadChart(item_height,root)
            {
                var w = 1120,
                    h = 800,
                    x = d3.scale.linear().range([0, w]),
                    y = d3.scale.linear().range([0, h]);
                var partition = d3.layout.partition()
                                  .sort(function(a,b){return d3.ascending(a.index,b.index);})
                                  .value(function(d) { return d.size; });
                d3.select("#chart").remove();
                var vis = d3.select("#chart_container")
                            .append("div")
                            .attr("id","chart")
                            .attr("class", "chart")
                            .style("width", w + "px")
                            .style("height", h + "px")
                            .append("svg:svg")
                            .attr("width", w)
                            .attr("height", h);
                        
                var g = vis.selectAll("g")
                           .data(partition.nodes(root))
                           .enter().append("svg:g")
                           .attr("transform", function(d) { return "translate(" + x(d.y) + "," + y(d.x) + ")"; })
                           .on("click", click);

                var kx = w / root.dx,
                    ky = h / 1;
                g.append("svg:rect")
                 .attr("width", function(d) { return (d.dy * kx);})
                 .attr("height", function(d) { return d.dx * ky; })
                 .attr("class", class_type);

                g.append("svg:text")
                 .attr("transform", textTransform)
                 .style("opacity", function(d) { return d.dx * ky > 12 ? 1 : 0; })
                 .text(function(d) { return d.size? (d.name + " @ " + d.address + " (" + d.size + ")") : d.name; })

                d3.select(window)
                  .on("click", function() { click(root); })

                function click(d)
                {
                    kx = (d.y ? w - 50 : w) / (1 - d.y);
                    ky = h / d.dx;
                    x.domain([d.y, 1]).range([d.y ? 50 : 0, w]);
                    y.domain([d.x, d.x + d.dx]);
                    var t = g.transition()
                             .duration(750)
                             .attr("transform", function(d) { return "translate(" + x(d.y) + "," + y(d.x) + ")"; });

                    t.select("rect")
                     .attr("width", function(d) { return (d.dy * kx);})
                     .attr("height", function(d) { return d.dx * ky; });

                    t.select("text")
                     .attr("transform", textTransform)
                     .style("opacity", function(d) { return d.dx * ky > 12 ? 1 : 0; });

                    d3.event.stopPropagation();
                }
                
                function class_type(d)
                {
                    if (d.name == "*fill*")
                    {
                        return "fill";
                    }
                    else if (d.name == "")
                    {
                        return "base";
                    }
                    else if (d.children)
                    {
                        return "parent";
                    }
                    else
                    {
                        return "children";
                    }
                }
                function textTransform(d)
                {
                    return "translate(" + (8) + "," + (d.dx + 12) + ")";
                }
            }
        </script>
    </body>
</html>
